# .github/workflows/ci.yml
name: Python CI (uv + Ruff)

on:
  # æ¯æ¬¡ push åˆ° main æˆ– pull request æ™‚è§¸ç™¼
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # æ¸¬è©¦æœ€æ–°çš„ Python ç‰ˆæœ¬
        python-version: ["3.11", "3.12"]

    steps:
    - name: â¬‡ï¸ æª¢æŸ¥ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # --- é—œéµæ­¥é©Ÿï¼šä½¿ç”¨ UV é€²è¡Œå®‰è£èˆ‡åŒæ­¥ ---
    - name: âš™ï¸ å®‰è£ UV (Rust-based Package Manager)
      run: pip install uv

    - name: ğŸ”’ æª¢æŸ¥ UV é–å®šæª”æ˜¯å¦æ˜¯æœ€æ–°çš„ (Check Lockfile Freshness)
      # uv lock --check æœƒç¢ºä¿ pyproject.toml çš„è®Šå‹•å·²ç¶“åŒæ­¥åˆ° uv.lock
      run: uv lock --check

    - name: ğŸ“¦ åŒæ­¥è™›æ“¬ç’°å¢ƒä¸¦å®‰è£ä¾è³´
      run: uv sync --with test # å®‰è£ä¸»ä¾è³´å’Œæ¸¬è©¦ä¾è³´

    # --- ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ (Ruff) ---
    - name: ğŸ§¹ é‹è¡Œ Ruff Linter (Linting)
      # ä½¿ç”¨ uv run ç¢ºä¿ Ruff åœ¨æ­£ç¢ºçš„ç’°å¢ƒå…§åŸ·è¡Œ
      run: uv run ruff check .

    - name: ğŸ’… é‹è¡Œ Ruff Formatter (æ ¼å¼æª¢æŸ¥)
      # ç¢ºä¿æ‰€æœ‰ç¨‹å¼ç¢¼éƒ½å·²æ ¼å¼åŒ– (åƒ…æª¢æŸ¥ï¼Œä¸ä¿®æ”¹)
      run: uv run ruff format . --check

    # --- æ ¸å¿ƒå–®å…ƒ/API æ¸¬è©¦ (Pytest) ---
    - name: ğŸ§ª é‹è¡Œ Pytest æ¸¬è©¦
      # è¨­å®š GEMINI_API_KEY è®“ AI æœå‹™èƒ½å¤ é‹è¡Œ (ä½¿ç”¨ Secrets é¿å…æ´©æ¼)
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        CWA_API_KEY: ${{ secrets.CWA_API_KEY }}
        MONGO_URI: "mongodb://localhost:27017" # CI ç’°å¢ƒä¸­å¯ä»¥æ¨¡æ“¬æˆ–ä½¿ç”¨å‡çš„é€£ç·š
      run: uv run pytest tests/
