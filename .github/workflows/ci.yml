# .github/workflows/ci.yml
name: Python CI (uv + Ruff)

on:
  # æ¯æ¬¡ push åˆ° main æˆ– pull request æ™‚è§¸ç™¼
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # æ¸¬è©¦æœ€æ–°çš„ Python ç‰ˆæœ¬
        python-version: ["3.12"]

    # ğŸŒŸ é—œéµæ–°å¢ï¼šä½¿ç”¨ Service Container
    services:
      mongodb: # æœå‹™åç¨±ï¼Œæ‚¨åœ¨ä»£ç¢¼ä¸­å°‡ä½¿ç”¨é€™å€‹åç¨±ä½œç‚ºä¸»æ©Ÿå
        image: mongo:latest # ä½¿ç”¨å®˜æ–¹çš„ MongoDB æ˜ åƒæª”
        ports:
          - 27017:27017 # å°‡å®¹å™¨çš„ 27017 åŸ æ˜ å°„å‡ºä¾†
        options: >
          --name mongodb_ci # çµ¦å®¹å™¨ä¸€å€‹åç¨±

    steps:
    - name: â¬‡ï¸ æª¢æŸ¥ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # --- é—œéµæ­¥é©Ÿï¼šä½¿ç”¨ UV é€²è¡Œå®‰è£èˆ‡åŒæ­¥ ---
    - name: âš™ï¸ å®‰è£ UV (Rust-based Package Manager)
      run: pip install uv

    - name: ğŸ”’ æª¢æŸ¥ UV é–å®šæª”æ˜¯å¦æ˜¯æœ€æ–°çš„ (Check Lockfile Freshness)
      # uv lock --check æœƒç¢ºä¿ pyproject.toml çš„è®Šå‹•å·²ç¶“åŒæ­¥åˆ° uv.lock
      run: uv lock --check

    - name: ğŸŒ å»ºç«‹è™›æ“¬ç’°å¢ƒ (Virtual Environment)
      # uv venv æœƒåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å‰µå»ºä¸€å€‹ .venv è³‡æ–™å¤¾
      run: uv venv

    - name: ğŸ“¦ åŒæ­¥è™›æ“¬ç’°å¢ƒä¸¦å®‰è£ä¾è³´ (ä¿®æ­£ç‚º uv pip install)
       # ä½¿ç”¨ 'uv pip install .' ä¾†å®‰è£å°ˆæ¡ˆæœ¬èº«çš„ä¸»ä¾è³´ (å¾ pyproject.toml çš„ [project])
       # ä½¿ç”¨ '--with test' ä¾†é¡å¤–å®‰è£ 'test' ä¾è³´çµ„ (å¾ [project.optional-dependencies] æˆ– [tool.uv.dev-dependencies])
      run: uv pip install --group dev .

    - name: ğŸ§¹ é‹è¡Œ Ruff Linter (Linting)
      # ä½¿ç”¨ uv run ç¢ºä¿ Ruff åœ¨æ­£ç¢ºçš„ç’°å¢ƒå…§åŸ·è¡Œ
      run: uv run ruff check .

    - name: ğŸ’… é‹è¡Œ Ruff Formatter (æ ¼å¼æª¢æŸ¥)
      # ç¢ºä¿æ‰€æœ‰ç¨‹å¼ç¢¼éƒ½å·²æ ¼å¼åŒ– (åƒ…æª¢æŸ¥ï¼Œä¸ä¿®æ”¹)
      run: uv run ruff format . --check

   # --- æ ¸å¿ƒæ¸¬è©¦æ­¥é©Ÿ ---

    # 1. ğŸ§ª é‹è¡Œå–®å…ƒæ¸¬è©¦ (Unit Tests - UT)
    # ç›®çš„ï¼šé‹è¡Œæ‰€æœ‰ä¸åŒ…å« 'integration' æ¨™è¨˜çš„æ¸¬è©¦ã€‚
    # ç‰¹é»ï¼šä¸éœ€è¦å¤–éƒ¨ç¶²è·¯é€£ç·šï¼Œé€Ÿåº¦æœ€å¿«ï¼Œæ˜¯æ¯æ¬¡ PR çš„ä¸»è¦é˜²ç·šã€‚
    - name: ğŸš€ é‹è¡Œå–®å…ƒ/API æ¨¡æ“¬æ¸¬è©¦ (UT)
      # UT åªéœ€è¦æ¨¡æ“¬çš„ MONGO_URIï¼Œä¸éœ€è¦çœŸå¯¦çš„ AI é‡‘é‘°
      env:
        GEMINI_API_KEY: "dummy_gemini_api_key"
        CWA_API_KEY: "dummy_cwa_api_key"
        MONGO_URI: "mongodb://localhost:27017"
      # -m "not integration" ç¢ºä¿åªé‹è¡Œä¸éœ€è¦çœŸå¯¦é€£ç·šçš„ Mocked æ¸¬è©¦
      run: uv run pytest tests/ -m "not integration"

    # 2. ğŸŒ é‹è¡Œæ•´åˆæ¸¬è©¦ (Integration Tests) - ç¨ç«‹æ­¥é©Ÿ
    # ç›®çš„ï¼šæª¢æŸ¥èˆ‡çœŸå¯¦ Gemini/CWA API çš„é€£ç·šå’Œå›æ‡‰æ ¼å¼ã€‚
    # ç‰¹é»ï¼šéœ€è¦çœŸå¯¦çš„é‡‘é‘°å’Œç¶²è·¯é€£ç·šã€‚
    - name: ğŸŒ é‹è¡ŒçœŸå¯¦æ•´åˆæ¸¬è©¦ (Integration Tests)
      # âš ï¸ åƒ…åœ¨ main åˆ†æ”¯ push æ™‚åŸ·è¡Œ æˆ– æ‰‹å‹•å•Ÿç”¨æ™‚æ‰åŸ·è¡Œï¼Œä»¥ç¯€çœ API è²»ç”¨
      if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # å¿…é ˆä½¿ç”¨çœŸå¯¦é‡‘é‘°
        CWA_API_KEY: ${{ secrets.CWA_API_KEY }}       # å¿…é ˆä½¿ç”¨çœŸå¯¦é‡‘é‘°
        MONGO_URI: "mongodb://mongodb:27017" # MongoDB æœå‹™åœ¨ CI ç’°å¢ƒä¸­é‹è¡Œ
      # -m "integration" ç¢ºä¿åªé‹è¡Œå¸¶æœ‰æ•´åˆæ¨™è¨˜çš„æ¸¬è©¦
      run: uv run pytest tests/ -m "integration"
